<!DOCTYPE html>
<html>
<head>
    <title>WSJFOptimizer</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",onScopeChange:function(scope){this.callParent(arguments),this.start(scope)},start:function(scope){this.down("label")&&this.down("label").destroy(),this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading..."}),this._myMask.show(),console.log("Loading Feature for "+scope.record.data.Name);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature"],fetch:["ObjectID","JobSize","RROEValue","TimeCriticality","UserBusinessValue","WSJFScore","Name","Predecessors"],filters:[{property:"Release.Name",value:scope.record.data.Name}],context:dataScope,limit:1/0},this);store.load({scope:this,callback:function(records,operation){if(operation.wasSuccessful())if(records.length>0){var features=[];_.each(records,function(record){var feature={};feature.ref=record.raw._ref,feature.id=record.raw.ObjectID,feature.name=record.raw.Name,feature.jobSize=record.raw.JobSize,feature.rroeValue=record.raw.RROEValue,feature.timeCriticality=record.raw.TimeCriticality,feature.userBusinessValue=record.raw.UserBusinessValue,feature.wsjfScore=record.raw.WSJFScore,feature.predecessorsCount=record.raw.Predecessors.Count,feature.predecessors=[],0!==feature.jobSize&&features.push(feature)},this),this.checkPredecessors(features)}else 0===records.length&&0===this.features.length&&this.showNoDataBox()}})},checkPredecessors:function(features){var foundPredecessor=!1;_.each(features,function(feature){feature.predecessors.length<feature.predecessorsCount&&!foundPredecessor&&(foundPredecessor=!0,this.loadPredecessors(feature,features))},this),foundPredecessor||this.calculateWSJFScores(features)},loadPredecessors:function(feature,features){console.log("Loading predecessors for "+feature.id);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature"],fetch:["ObjectID"],filters:[{property:"Successors",operator:"contains",value:feature.ref}],context:dataScope,limit:1/0},this);store.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&_.each(records,function(record){feature.predecessors.push(record.raw.ObjectID)},this),this.checkPredecessors(features)}})},calculateWSJFScores:function(features){console.log("Calculating WSJF Scores"),_.each(features,function(feature){this.calculateWSJFScore(feature,features)},this),console.log("Sorting Features by WSJF Score"),_.sortBy(features,"wsjfScore"),console.log(features)},calculateWSJFScore:function(feature,features){if(0===feature.wsjfScore){var totalValue=feature.rroeValue+feature.timeCriticality+feature.userBusinessValue,totalJobSize=feature.jobSize;_.each(feature.predecessors,function(predecessorID){var predecessor=null;_.each(features,function(predecessorFeature){predecessorFeature.id==predecessorID&&(predecessor=predecessorFeature)},this),this.calculateWSJFScore(predecessor,features),totalValue+=predecessor.rroeValue+predecessor.timeCriticality+predecessor.userBusinessValue,totalJobSize+=predecessor.jobSize},this),feature.wsjfScore=totalValue/totalJobSize}},compileData:function(){var chartArray=[];for(x=0;this.CAIntents.length>x;x++)for(chartArray.push([]),y=0;this.customerPerceivedValues.length>y;y++)chartArray[x].push([]);_.each(this.initiatives,function(initiative){initiative.CAIntent&&initiative.customerPerceivedValue&&chartArray[this.CAIntents.indexOf(initiative.CAIntent)][this.customerPerceivedValues.indexOf(initiative.customerPerceivedValue)].push(initiative)},this);var seriesData=[];for(x=0;this.CAIntents.length>x;x++)for(y=0;this.customerPerceivedValues.length>y;y++){var cell=chartArray[x][y];if(cell.length>0){cell.sort(function(a,b){return a.estimate<b.estimate});var series={},cellEstimate=cell.reduce(function(total,a){return total+a.estimate},0);series.marker={fillColor:cell[0].displayColor,lineColor:"#000000"},series.data=[{x:x,y:y,z:100*(cellEstimate/this.totalPoints),name:cell.reduce(function(string,a){return string+a.formattedId+"<br/>"},""),tooltip:cell.reduce(function(string,a){return string+"<b>"+a.formattedId+": </b>"+a.name+" = "+Math.round(100*(a.estimate/cellEstimate))+"%<br/>"},""),color:cell[0].displayColor}],seriesData.push(series)}}this.makeChart(seriesData)},makeChart:function(seriesData){var CAIntentsCategories=this.CAIntents,customerPerceivedValuesCategories=this.customerPerceivedValues,chart=this.add({xtype:"rallychart",chartConfig:{chart:{type:"bubble",zoomType:"xy"},legend:{enabled:!1},xAxis:{title:{text:"CA Intent"},labels:{formatter:function(){return CAIntentsCategories[this.value]}},tickInterval:1,min:0,max:CAIntentsCategories.length-1},yAxis:{title:{text:"Customer Perceived Value"},labels:{formatter:function(){return customerPerceivedValuesCategories[this.value]}},tickInterval:1,min:0,max:customerPerceivedValuesCategories.length-1},title:{text:"Initiatives by CA Intents and Customer Perceived Value"},tooltip:{useHTML:!0,pointFormat:"{point.tooltip}",headerFormat:""},plotOptions:{series:{dataLabels:{enabled:!0,useHTML:!0,format:"{point.name}",color:"#ffffff",shadow:!1}}}},chartData:{series:seriesData}});this._myMask.hide()},showNoDataBox:function(){this._myMask.hide(),this.add({xtype:"label",text:"There is no data. Check if there are work items assigned for the Release."})}});

            Rally.launchApp('CustomApp', {
                name:"WSJFOptimizer",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
