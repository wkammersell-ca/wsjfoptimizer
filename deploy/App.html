<!DOCTYPE html>
<html>
<head>
    <title>WSJFOptimizer</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",onScopeChange:function(scope){this.callParent(arguments),this.start(scope)},start:function(scope){this.down("label")&&this.down("label").destroy(),this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading..."}),this._myMask.show(),console.log("Loading Feature for "+scope.record.data.Name);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature"],fetch:["ObjectID","JobSize","RROEValue","TimeCriticality","UserBusinessValue","WSJFScore","Name","Predecessors","DragAndDropRank"],filters:[{property:"Release.Name",value:scope.record.data.Name}],context:dataScope,limit:1/0},this);store.load({scope:this,callback:function(records,operation){if(operation.wasSuccessful())if(records.length>0){var features=[];_.each(records,function(record){var feature={};feature.ref=record.raw._ref,feature.id=record.raw.ObjectID,feature.name=record.raw.Name,feature.rank=record.raw.DragAndDropRank,feature.jobSize=record.raw.JobSize,feature.rroeValue=record.raw.RROEValue,feature.timeCriticality=record.raw.TimeCriticality,feature.userBusinessValue=record.raw.UserBusinessValue,feature.wsjfScore=record.raw.WSJFScore,feature.predecessorsCount=record.raw.Predecessors.Count,feature.predecessors=[],0!==feature.jobSize&&features.push(feature)},this),this.checkPredecessors(features)}else 0===records.length&&0===this.features.length&&this.showNoDataBox()}})},checkPredecessors:function(features){var foundPredecessor=!1;_.each(features,function(feature){feature.predecessors.length<feature.predecessorsCount&&!foundPredecessor&&(foundPredecessor=!0,this.loadPredecessors(feature,features))},this),foundPredecessor||this.calculateWSJFScores(features)},loadPredecessors:function(feature,features){console.log("Loading predecessors for "+feature.id);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature"],fetch:["ObjectID"],filters:[{property:"Successors",operator:"contains",value:feature.ref}],context:dataScope,limit:1/0},this);store.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&_.each(records,function(record){var predecessorFeature=null;_.each(features,function(possibleFeature){possibleFeature.id==record.raw.ObjectID&&(predecessorFeature=possibleFeature)},this),predecessorFeature&&feature.predecessors.push(predecessorFeature)},this),this.checkPredecessors(features)}})},calculateWSJFScores:function(features){console.log("Calculating WSJF Scores"),_.each(features,function(feature){this.calculateWSJFScore(feature,features)},this),this.compileData(features)},calculateWSJFScore:function(feature,features){if(0===feature.wsjfScore){var totalValue=feature.rroeValue+feature.timeCriticality+feature.userBusinessValue,totalJobSize=feature.jobSize;_.each(feature.predecessors,function(predecessor){this.calculateWSJFScore(predecessor,features),totalValue+=predecessor.rroeValue+predecessor.timeCriticality+predecessor.userBusinessValue,totalJobSize+=predecessor.jobSize},this),feature.wsjfScore=totalValue/totalJobSize}},compileData:function(features){var scoredFeatures=features,rankedFeatures=features.slice();scoredFeatures=this.sortFeatures(scoredFeatures,"wsjfScore"),rankedFeatures=this.sortFeatures(rankedFeatures,"rank"),console.log(scoredFeatures),console.log(rankedFeatures)},sortFeatures:function(features,attribute,sortedFeatures){return console.log("Sorting "+features.length+" features by "+attribute),sortedFeatures=sortedFeatures||[],features.sort(function(a,b){return a[attribute]<b[attribute]}),_.each(features,function(feature){var foundFeature=!1;_.each(sortedFeatures,function(sortedFeature){sortedFeature.id==feature.id&&(foundFeature=!0)},this),foundFeature||(feature.predecessors.length>0&&this.sortFeatures(feature.predecessors,attribute,sortedFeatures),console.log("Adding "+feature.name),sortedFeatures.push(feature),console.log(sortedFeatures))},this),sortedFeatures},showNoDataBox:function(){this._myMask.hide(),this.add({xtype:"label",text:"There is no data. Check if there are work items assigned for the Release."})}});

            Rally.launchApp('CustomApp', {
                name:"WSJFOptimizer",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
